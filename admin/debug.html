<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amaranth Admin — Debug Tools</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f7f7fb;
      color: #111;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    h1 {
      margin: 0;
      font-size: 22px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fee2e2;
      color: #991b1b;
      font-weight: 600;
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 10px;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      padding: 14px;
    }
    .card h3 {
      margin: 0 0 8px;
      font-size: 15px;
    }
    .card p {
      margin: 0 0 8px;
      font-size: 13px;
      color: #4b5563;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      background: #4f46e5;
      color: #fff;
      border-color: #4f46e5;
    }
    button.danger {
      background: #b91c1c;
      color: #fff;
      border-color: #b91c1c;
    }
    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
    label {
      font-size: 13px;
      color: #374151;
      display: block;
      margin-bottom: 4px;
    }
    input[type="email"],
    input[type="text"],
    select {
      width: 100%;
      max-width: 320px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      box-sizing: border-box;
    }
    small {
      font-size: 11px;
      color: #6b7280;
      display: block;
      margin-top: 2px;
    }
    pre {
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      overflow: auto;
      max-height: 360px;
      border: 1px solid #0f172a;
      margin: 0;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #eef2ff;
      color: #3730a3;
      margin-left: 6px;
    }
    .status-ok { color: #166534; }
    .status-bad { color: #b91c1c; }
    .token-warning {
      font-size: 12px;
      color: #b91c1c;
      margin-top: 6px;
    }
    a.admin-link {
      font-size: 13px;
      color: #4f46e5;
      text-decoration: none;
    }
    a.admin-link:hover {
      text-decoration: underline;
    }
    /* Make output card full-width like debug2 */
    .card-output {
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Debug Tools</h1>
        <div class="pill">Danger — use on production with care</div>
      </div>
      <nav>
        <a class="admin-link" href="/admin/index.html">← Admin Hub</a>
      </nav>
    </header>

    <div class="cards-grid">
      <!-- Auth / Environment ------------------------------------------------- -->
      <div class="card">
        <h3>Auth / Context</h3>
        <p id="authStatus">Checking admin token…</p>
        <p class="token-warning" id="tokenWarning" style="display:none;">
          No admin token found. Please log in via <a href="/admin/login.html" class="admin-link">Admin Login</a> first.
        </p>
      </div>

      <div class="card">
        <h3>Admin Token Test <span class="badge">GET ?type=debug_token</span></h3>
        <p>
          Asks the server to compare your current <code>Authorization</code> header
          (from <code>localStorage.amaranth_report_token</code>) against
          <code>REPORT_TOKEN</code> and report if they match.
        </p>
        <div class="btn-row">
          <button id="btnTokenTest">Run Token Test</button>
        </div>
      </div>

      <div class="card">
        <h3>Environment Smoketest <span class="badge">GET ?type=smoketest</span></h3>
        <p>Checks Node version, Stripe keys, Resend, and KV connectivity in one shot.</p>
        <div class="btn-row">
          <button id="btnSmoketest" class="primary">Run Smoketest</button>
        </div>
      </div>

      <div class="card">
        <h3>Stripe Connectivity <span class="badge">GET ?type=debug_stripe</span></h3>
        <p>Lightweight, public-safe check that Stripe is configured and reachable using <code>STRIPE_SECRET_KEY</code>.</p>
        <div class="btn-row">
          <button id="btnStripeTest">Run Stripe Test</button>
        </div>
      </div>

      <div class="card">
        <h3>Resend API Debug <span class="badge">GET ?type=debug_resend</span></h3>
        <p>
          Sends a simple debug email via the <code>admin/debug.js</code> handler using <code>RESEND_API_KEY</code>.
          Uses <code>?to=</code> if provided, otherwise falls back to <code>REPORTS_LOG_TO</code> / <code>RESEND_FROM</code>.
        </p>
        <label for="resendDebugTo">Send debug email to</label>
        <input type="email" id="resendDebugTo" placeholder="someone@example.com (optional)" />
        <small>Leave blank to use REPORTS_LOG_TO / RESEND_FROM defaults.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnResendDebug">Run Resend Debug</button>
        </div>
      </div>

      <!-- Email & Mail Logs -------------------------------------------------- -->
      <div class="card">
        <h3>Manual Resend Test <span class="badge">POST action=test_resend</span></h3>
        <p>
          Queues a simple test email via the main router
          (<code>action=test_resend</code>) to confirm outgoing mail is working.
        </p>
        <label for="resendTo">Send test email to</label>
        <input type="email" id="resendTo" placeholder="someone@example.com" />
        <small>If left blank, it will use the first address from REPORTS_BCC / REPORTS_CC.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnTestResend" class="primary">Send Test Email (router)</button>
        </div>
      </div>

      <div class="card">
        <h3>Last Mail Log <span class="badge">GET ?type=lastmail</span></h3>
        <p>Fetches the most recent mail log entry stored under <code>MAIL_LOG_KEY</code>.</p>
        <div class="btn-row">
          <button id="btnLastMail">Load Last Mail Log</button>
        </div>
      </div>

      <!-- Scheduler & Chair Reports ----------------------------------------- -->
      <div class="card">
        <h3>Scheduler Diagnostic <span class="badge">GET ?type=debug_scheduler</span></h3>
        <p>
          Shows daily / weekly / twice-per-month / monthly windows and how various
          frequency strings normalize via <code>normalizeReportFrequency</code>.
        </p>
        <div class="btn-row">
          <button id="btnSchedulerDiag">Run Scheduler Diagnostic</button>
        </div>
      </div>

      <div class="card">
        <h3>Scheduler Dry Run <span class="badge">GET ?type=debug_scheduler_dry_run</span></h3>
        <p>
          Simulates the scheduler without sending any emails. For each item shows
          report window, row counts, and whether it <em>would</em> send now and why.
        </p>
        <div class="btn-row">
          <button id="btnSchedulerDryRun">Run Scheduler Dry Run</button>
        </div>
      </div>

      <div class="card">
        <h3>Chair Report Preview <span class="badge">GET ?type=debug_chair_preview</span></h3>
        <p>
          Shows which rows a chair report <em>would</em> include for a specific item,
          either full history or just the current calendar month.
        </p>
        <label for="chairItemId">Item ID</label>
        <input type="text" id="chairItemId" placeholder="e.g. trails-feast, gf-officers-breakfast" />
        <label for="chairScope" style="margin-top:8px;">Scope</label>
        <select id="chairScope">
          <option value="full">Full history</option>
          <option value="current-month">Current month only</option>
        </select>
        <small>Uses <code>admin/debug.js</code> <code>handleChairPreview()</code> under the hood.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnChairPreview" class="primary">Run Chair Preview</button>
        </div>
      </div>

      <div class="card">
        <h3>Item Schedule Debug <span class="badge">POST action=debug_schedule&amp;id=&lt;itemId&gt;</span></h3>
        <p>
          Calls the <code>debug_schedule</code> endpoint in <code>/api/router</code> to inspect
          the current report schedule and publish window for a specific item ID.
        </p>
        <label for="debugItemId">Item ID to debug</label>
        <input type="text" id="debugItemId" placeholder="e.g. trails-feast, gf-officers-breakfast" />
        <small>Uses your current admin token for authorization.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnDebugSchedule" class="primary">Run Schedule Debug</button>
        </div>
      </div>

      <!-- Orders & Item Health ---------------------------------------------- -->
      <div class="card">
        <h3>Orders Index Health <span class="badge">GET ?type=debug_orders_health</span></h3>
        <p>
          Checks <code>orders:index</code> for missing <code>order:&lt;id&gt;</code> keys and
          shows earliest / latest order timestamps plus sample flattened rows.
        </p>
        <div class="btn-row">
          <button id="btnOrdersHealth">Run Orders Health Check</button>
        </div>
      </div>

      <div class="card">
        <h3>Item Config Health <span class="badge">GET ?type=debug_itemcfg_health</span></h3>
        <p>
          Dumps <code>itemcfg:index</code> entries, checking chair emails, publish windows,
          and normalized <code>reportFrequency</code> for each item.
        </p>
        <div class="btn-row">
          <button id="btnItemcfgHealth">Run Itemcfg Health Check</button>
        </div>
      </div>

      <div class="card">
        <h3>Order Preview <span class="badge">GET ?type=debug_order_preview</span></h3>
        <p>
          Loads a stored <code>order:&lt;id&gt;</code> and shows its flattened rows as used by reporting.
        </p>
        <label for="orderPreviewId">Order ID</label>
        <input type="text" id="orderPreviewId" placeholder="e.g. order_123, cs_test_order" />
        <small>Use IDs from Stripe webhook logs or your own admin exports.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnOrderPreview">Run Order Preview</button>
        </div>
      </div>

      <div class="card">
        <h3>Webhook Session Preview <span class="badge">GET ?type=debug_webhook_preview</span></h3>
        <p>
          Fetches a Stripe <code>checkout.session</code> (with payment intent and line items) for a given
          <code>session_id</code>, to compare with your stored order.
        </p>
        <label for="webhookSessionId">Stripe Session ID</label>
        <input type="text" id="webhookSessionId" placeholder="e.g. cs_test_123..." />
        <small>Use the <code>checkout.session.completed</code> IDs from Stripe's dashboard/logs.</small>
        <div class="btn-row" style="margin-top:8px;">
          <button id="btnWebhookPreview">Run Webhook Session Preview</button>
        </div>
      </div>

      <!-- Output ------------------------------------------------------------- -->
      <div class="card card-output">
        <h3>Output</h3>
        <p>
          Results from the selected action will appear here as formatted JSON.
          <span id="outputStatus" class="status-ok"></span>
        </p>
        <pre id="output">{ }</pre>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "/api/router";
    const TOKEN_KEY = "amaranth_report_token";

    const authStatusEl = document.getElementById("authStatus");
    const tokenWarningEl = document.getElementById("tokenWarning");
    const outputEl = document.getElementById("output");
    const outputStatusEl = document.getElementById("outputStatus");

    const btnSmoketest = document.getElementById("btnSmoketest");
    const btnTokenTest = document.getElementById("btnTokenTest");
    const btnStripeTest = document.getElementById("btnStripeTest");
    const btnResendDebug = document.getElementById("btnResendDebug");
    const btnLastMail = document.getElementById("btnLastMail");
    const btnSchedulerDiag = document.getElementById("btnSchedulerDiag");
    const btnTestResend = document.getElementById("btnTestResend");
    const btnDebugSchedule = document.getElementById("btnDebugSchedule");

    const btnOrdersHealth = document.getElementById("btnOrdersHealth");
    const btnItemcfgHealth = document.getElementById("btnItemcfgHealth");
    const btnSchedulerDryRun = document.getElementById("btnSchedulerDryRun");
    const btnChairPreview = document.getElementById("btnChairPreview");
    const btnOrderPreview = document.getElementById("btnOrderPreview");
    const btnWebhookPreview = document.getElementById("btnWebhookPreview");

    const resendToInput = document.getElementById("resendTo");
    const resendDebugToInput = document.getElementById("resendDebugTo");
    const debugItemIdInput = document.getElementById("debugItemId");

    const chairItemIdInput = document.getElementById("chairItemId");
    const chairScopeSelect = document.getElementById("chairScope");
    const orderPreviewIdInput = document.getElementById("orderPreviewId");
    const webhookSessionIdInput = document.getElementById("webhookSessionId");

    function getToken() {
      try {
        return localStorage.getItem(TOKEN_KEY) || "";
      } catch {
        return "";
      }
    }

    function authHeaders() {
      const token = getToken();
      const h = {};
      if (token) h["Authorization"] = "Bearer " + token;
      return h;
    }

    function setButtonsDisabled(disabled) {
      [
        btnSmoketest,
        btnTokenTest,
        btnStripeTest,
        btnResendDebug,
        btnLastMail,
        btnSchedulerDiag,
        btnTestResend,
        btnDebugSchedule,
        btnOrdersHealth,
        btnItemcfgHealth,
        btnSchedulerDryRun,
        btnChairPreview,
        btnOrderPreview,
        btnWebhookPreview
      ].forEach((b) => {
        if (!b) return;
        b.disabled = disabled;
      });
    }

    function showJSON(label, data) {
      outputStatusEl.textContent = label ? " – " + label : "";
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      try {
        outputEl.textContent = JSON.stringify(data, null, 2);
      } catch {
        outputEl.textContent = String(data);
      }
    }

    function showError(err) {
      outputStatusEl.textContent = " – Error";
      outputStatusEl.classList.remove("status-ok");
      outputStatusEl.classList.add("status-bad");
      outputEl.textContent = String(err && err.message ? err.message : err);
    }

    async function runSmoketest() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running smoketest…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=smoketest", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data && data.error ? data.error : "HTTP " + res.status);
        }
        showJSON("Smoketest OK", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runTokenTest() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running token test…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_token", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(
            (data && (data.message || data.error)) || "HTTP " + res.status
          );
        }
        const label = data && data.ok ? "Token matches REPORT_TOKEN" : "Token mismatch / error";
        showJSON(label, data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runStripeTest() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running Stripe test…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_stripe", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Stripe connectivity OK", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runResendDebug() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running Resend debug…";
      outputEl.textContent = "";

      const to = (resendDebugToInput.value || "").trim();
      const qs = to ? "?type=debug_resend&to=" + encodeURIComponent(to) : "?type=debug_resend";

      try {
        const res = await fetch(API_BASE + qs, {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Resend debug email sent", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function loadLastMail() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Loading last mail log…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=lastmail", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data && data.error ? data.error : "HTTP " + res.status);
        }
        showJSON("Last mail log", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runSchedulerDiag() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running scheduler diagnostic…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_scheduler", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Scheduler diagnostic", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runTestResend() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Sending test email (router)…";
      outputEl.textContent = "";

      const to = (resendToInput.value || "").trim();

      try {
        const res = await fetch(API_BASE + "?action=test_resend", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            ...authHeaders(),
          },
          body: JSON.stringify(to ? { to } : {}),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data && data.message ? data.message : "HTTP " + res.status);
        }
        showJSON("Test email queued (router)", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runOrdersHealth() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running orders health check…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_orders_health", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Orders index health", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runItemcfgHealth() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running itemcfg health check…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_itemcfg_health", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Itemcfg health", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runSchedulerDryRun() {
      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running scheduler dry run…";
      outputEl.textContent = "";

      try {
        const res = await fetch(API_BASE + "?type=debug_scheduler_dry_run", {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Scheduler dry run", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runChairPreview() {
      const id = (chairItemIdInput.value || "").trim();
      const scope = (chairScopeSelect.value || "full").trim() || "full";

      if (!id) {
        showError("Please enter an item ID first.");
        return;
      }

      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running chair preview…";
      outputEl.textContent = "";

      const qs =
        "?type=debug_chair_preview&id=" +
        encodeURIComponent(id) +
        "&scope=" +
        encodeURIComponent(scope);

      try {
        const res = await fetch(API_BASE + qs, {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Chair preview for " + id + " (" + scope + ")", data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runOrderPreview() {
      const oid = (orderPreviewIdInput.value || "").trim();
      if (!oid) {
        showError("Please enter an order ID first.");
        return;
      }

      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running order preview…";
      outputEl.textContent = "";

      const qs =
        "?type=debug_order_preview&id=" + encodeURIComponent(oid);

      try {
        const res = await fetch(API_BASE + qs, {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Order preview for " + oid, data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runWebhookPreview() {
      const sid = (webhookSessionIdInput.value || "").trim();
      if (!sid) {
        showError("Please enter a Stripe session ID first.");
        return;
      }

      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running webhook session preview…";
      outputEl.textContent = "";

      const qs =
        "?type=debug_webhook_preview&session_id=" +
        encodeURIComponent(sid);

      try {
        const res = await fetch(API_BASE + qs, {
          headers: {
            "Accept": "application/json",
            ...authHeaders(),
          },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(
            (data && (data.error || data.message)) || "HTTP " + res.status
          );
        }
        showJSON("Webhook session preview for " + sid, data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    async function runDebugSchedule() {
      const id = (debugItemIdInput.value || "").trim();
      if (!id) {
        showError("Please enter an item ID first.");
        return;
      }

      setButtonsDisabled(true);
      outputStatusEl.classList.remove("status-bad");
      outputStatusEl.classList.add("status-ok");
      outputStatusEl.textContent = " – Running schedule debug…";
      outputEl.textContent = "";

      try {
        const url = API_BASE + "?action=debug_schedule&id=" + encodeURIComponent(id);
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          body: "{}"
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(
            (data && (data.message || data.error)) || "HTTP " + res.status
          );
        }
        showJSON("Schedule debug for " + id, data);
      } catch (e) {
        showError(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    // Wire up events
    btnSmoketest.addEventListener("click", runSmoketest);
    btnTokenTest.addEventListener("click", runTokenTest);
    btnStripeTest.addEventListener("click", runStripeTest);
    btnResendDebug.addEventListener("click", runResendDebug);
    btnLastMail.addEventListener("click", loadLastMail);
    btnSchedulerDiag.addEventListener("click", runSchedulerDiag);
    btnTestResend.addEventListener("click", runTestResend);
    btnDebugSchedule.addEventListener("click", runDebugSchedule);

    btnOrdersHealth.addEventListener("click", runOrdersHealth);
    btnItemcfgHealth.addEventListener("click", runItemcfgHealth);
    btnSchedulerDryRun.addEventListener("click", runSchedulerDryRun);
    btnChairPreview.addEventListener("click", runChairPreview);
    btnOrderPreview.addEventListener("click", runOrderPreview);
    btnWebhookPreview.addEventListener("click", runWebhookPreview);

    // Init auth status (client-side quick check)
    (function initAuthStatus() {
      const token = getToken();
      if (token) {
        authStatusEl.innerHTML = `Admin token: <span class="status-ok">present</span>`;
        tokenWarningEl.style.display = "none";
      } else {
        authStatusEl.innerHTML = `Admin token: <span class="status-bad">missing</span>`;
        tokenWarningEl.style.display = "block";
      }
    })();
  </script>
</body>
</html>
