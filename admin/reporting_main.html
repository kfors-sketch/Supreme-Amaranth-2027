<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amaranth Admin ‚Äî Reporting Dashboard</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Shared styles (includes .help-btn and modal styles) -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:#f7f7fb;color:#111}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    .hide{display:none}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:14px}
    .card h3{margin:0 0 8px;font-size:15px;color:#374151}
    .card p{margin:4px 0 8px;font-size:13px;color:#4b5563}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .col{flex:1 1 0;min-width:260px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .controls label{font-size:12px;color:#4b5563}
    .controls input,.controls select{width:100%;height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px}
    .controls .group{flex:1 1 120px;min-width:120px}
    .btn{height:32px;border-radius:999px;border:1px solid #d1d5db;background:#111;color:#fff;font-size:13px;padding:0 14px;font-weight:600;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#111}
    .btn.sm{height:28px;font-size:12px;padding:0 10px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center}
    .toolbar .spacer{flex:1 1 auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 4px;text-align:left;vertical-align:top}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.03em;color:#6b7280;background:#f9fafb;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#f9fafb}
    .badge{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #e5e7eb;padding:1px 7px;font-size:11px;color:#374151;background:#f9fafb}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid #e5e7eb;background:#f9fafb}
    .pill.green{border-color:#16a34a;color:#166534;background:#ecfdf3}
    .pill.red{border-color:#dc2626;color:#b91c1c;background:#fef2f2}
    .pill.orange{border-color:#ea580c;color:#9a3412;background:#fff7ed}
    .tag-muted{background:#f3f4f6;color:#4b5563;border-color:#e5e7eb}
    .flex{display:flex}
    .flex.between{justify-content:space-between;align-items:center}
    .flex.gap-8{gap:8px}
    .mt-8{margin-top:8px}
    .mt-12{margin-top:12px}
    .mt-4{margin-top:4px}
    .text-right{text-align:right}
    .nowrap{white-space:nowrap}
    .w-100{width:100%}
    .chip{display:inline-flex;align-items:center;border-radius:999px;border:1px solid #e5e7eb;padding:2px 8px;font-size:11px;background:#f9fafb;color:#374151;margin-right:4px;margin-bottom:4px}
    .chip span{opacity:.7;margin-left:4px}
    .badge-dot{width:6px;height:6px;border-radius:999px;margin-right:4px}
    .badge-dot.green{background:#16a34a}
    .badge-dot.red{background:#ef4444}
    .badge-dot.gray{background:#9ca3af}
    .status-icon{font-size:11px;border-radius:999px;border:1px solid #e5e7eb;padding:0 6px;display:inline-flex;align-items:center;gap:3px}
    .status-icon span.dot{width:6px;height:6px;border-radius:999px;background:#9ca3af}
    .status-icon.paid span.dot{background:#16a34a}
    .status-icon.refunded span.dot{background:#ef4444}
    .status-icon.pending span.dot{background:#f97316}
    .table-wrap{max-height:480px;overflow:auto;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    .badge-sm{font-size:11px;padding:1px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;color:#4b5563}
    .text-sm{font-size:12px}
    .text-xs{font-size:11px}
    .mb-4{margin-bottom:4px}
    .mb-8{margin-bottom:8px}
    .mb-12{margin-bottom:12px}
    .mb-16{margin-bottom:16px}
    .border-top{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px}
    .right-controls{display:flex;flex-wrap:wrap;gap:8px}
    .right-controls .group{min-width:120px}
    .pill-blue{border-color:#2563eb;color:#1d4ed8;background:#eff6ff}
    .section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;margin-bottom:4px}
    .heading-row{display:flex;justify-content:space-between;align-items:flex-end;gap:8px;margin-bottom:12px}
    .heading-row h2{
      margin:0;
      font-size:20px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }
    .heading-row .muted{font-size:12px;max-width:420px}
    .heading-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    @media (max-width:768px){
      .row{flex-direction:column}
      .table-wrap{max-height:none}
      .heading-row{flex-direction:column;align-items:flex-start}
      .heading-actions{justify-content:flex-start}
    }

    #refundModal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;z-index:50}
    #refundModal[aria-hidden="false"]{display:flex}
    #refundModal .modal-inner{background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(15,23,42,.25);max-width:420px;width:100%;padding:16px}
    #refundModal h4{margin:0 0 8px;font-size:16px}
    #refundModal p{margin:0 0 8px;font-size:13px}
    #refundModal .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  
    /* Two-column layout for the Test + Receipts ZIP cards */
    .two-col-cards{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:stretch;
      margin-top:16px;
    }
    .two-col-cards > .card,
    .two-col-cards > section.card{
      flex:1 1 420px;
      max-width:calc(50% - 8px);
    }
    @media (max-width: 980px){
      .two-col-cards > .card,
      .two-col-cards > section.card{
        max-width:100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="heading-row">
      <div>
        <h2>
          Reporting Dashboard
          <button
            type="button"
            class="help-btn"
            data-help-id="reporting_main"
            aria-label="Help for Reporting Dashboard"
            onclick="window.showAdminHelp && window.showAdminHelp('reporting_main')"
          >?</button>
        </h2>
        <p class="muted">Download, email, and inspect registration data. Filters at the top affect most exports.</p>
      </div>
      <div class="heading-actions">
        <!-- Match the two link-style buttons from admin/banquets.html -->
        <a href="index.html" class="btn secondary sm">‚Üê Admin Hub</a>
        <a href="banquets.html" class="btn secondary sm">Banquet Manager</a>
        <button id="btnPrint" class="btn secondary sm">Print</button>
      </div>
    </div>

    <!-- Top filters + tools -->
    <div class="card mb-16">
      <div class="flex between mb-4">
        <div class="section-label">Filters &amp; tools</div>
        <button
          type="button"
          class="help-btn"
          data-help-id="reporting_filters"
          aria-label="Help for Filters and Tools"
        >?</button>
      </div>

      <div class="toolbar">
        <div class="group">
          <label class="muted">From date</label>
          <input id="dateFrom" type="date" />
        </div>
        <div class="group">
          <label class="muted">To date</label>
          <input id="dateTo" type="date" />
        </div>
        <div class="group">
          <label class="muted">Category</label>
          <select id="category">
            <option value="">All</option>
            <option value="banquet">Banquets</option>
            <option value="addon">Add-ons</option>
            <option value="catalog">Catalog</option>
          </select>
        </div>
        <div class="group">
          <label class="muted">Status</label>
          <select id="status">
            <option value="">Any</option>
            <option value="paid">Paid</option>
            <option value="pending">Pending</option>
            <option value="refunded">Refunded</option>
          </select>
        </div>
        <div class="group w-100" style="max-width:220px">
          <label class="muted">Search (name, email, item‚Ä¶)</label>
          <input id="search" type="text" placeholder="Search text‚Ä¶" />
        </div>
        <div class="spacer"></div>
        <div class="right-controls">
          <button id="btnExportCsv" class="btn sm">Export Filtered (.xlsx)</button>
          <button id="btnFullAttendeesCsv" class="btn sm secondary">Full Attendee List</button>
          <button id="btnSample" class="btn sm secondary">Load Sample</button>
          <button id="btnClear" class="btn sm secondary">Clear Local</button>
</div>
      </div>
      <p class="muted mt-4">These controls affect what you see in the table below and most downloads. Server data is never deleted from this page‚Äîonly your local cache.</p>
    </div>

    <div class="card mb-16">
          <div class="flex between mb-8">
            <div>
              <div class="section-label">Overview</div>
              <h3>
                Orders &amp; Payments
                <button
                  type="button"
                  class="help-btn"
                  data-help-id="reporting_orders"
                  aria-label="Help for Orders and Payments"
                >?</button>
              </h3>
              <p class="muted">Filtered by the controls above. Click a row for refund tools.</p>
            </div>
            <div class="text-right">
              <div class="badge">
                <span id="totalCount">0</span>&nbsp; rows
              </div>
              <div class="mt-4">
                <label for="rowsLimit" class="muted text-xs">Rows shown</label><br/>
                <select id="rowsLimit" class="text-xs" style="margin-top:2px;height:24px;border-radius:999px;border:1px solid #d1d5db;padding:0 6px;">
                  <option value="10">10</option>
                  <option value="15" selected>15</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="all">All</option>
                </select>
              </div>
              <div class="mt-4 text-xs muted">
                Refund: <strong id="grossAmount">$0.00</strong><br/>
                Net: <strong id="netAmount">$0.00</strong><br/>
                Paid: <span id="paidCount">0</span> ‚Ä¢ Pending: <span id="pendingCount">0</span> ‚Ä¢ Refunded: <span id="refundedCount">0</span>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Buyer</th>
                  <th>Item</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th class="text-right">Net</th>
                  <th class="text-right">Refund</th>
                  <th>Meta</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>



        <div class="row" style="margin-top:16px;">
      <div class="col" style="flex: 1 1 480px; max-width: 560px;">
        <div class="card mb-12">
      <div class="section-label">Testing</div>
      <h3>Send Test Chair Report Emails</h3>
      <p class="muted">
        Send the same chair report emails using <strong>live orders</strong>, but only to your test address.
        This does <strong>not</strong> affect scheduled chair emails.
      </p>

      <div class="controls mt-4">
        <div class="group" style="max-width:320px">
          <label class="muted">Send to</label>
          <input id="testReportTo" type="email" value="kfors@verizon.net" />
        </div>

        <div class="group" style="max-width:220px">
          <label class="muted">Frequency</label>
          <select id="testReportFreq">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="all">All</option>
          </select>
        </div>

        <div class="group" style="max-width:220px">
          <label class="muted">Scope</label>
          <select id="testReportScope">
            <option value="current-month" selected>Current month</option>
            <option value="full">Full history</option>
          </select>
        </div>
        <div class="group" style="max-width:220px">
          <label class="muted">Preview only</label>
          <div style="height:32px;display:flex;align-items:center;gap:8px;">
            <input id="testPreviewOnly" type="checkbox" />
            <span class="muted">No email</span>
          </div>
        </div>

        <div class="group" style="max-width:200px">
          <label class="muted">&nbsp;</label>
          <button id="btnSendTestReports" class="btn sm w-100">Run Test Now</button>
        </div>
      </div>

      <pre id="testReportOut" class="mt-8"
           style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-size:11px;white-space:pre-wrap;"></pre>
    </div>
      </div>
      <div class="col" style="flex: 1 1 480px; max-width: 560px;">
        <section class="card" style="margin-top:16px;">
  <h3>Receipts ZIP ‚Äî Auto Send Options</h3>
  <p class="muted" style="margin-top:6px;">
    Uses the selected <strong>Report Channel</strong> (below) or falls back to the <strong>Order Channel</strong> in Admin Settings (<code id="orderChannelLabel">‚Ä¶</code>) to decide whether it‚Äôs pulling from Stripe TEST vs LIVE.
  </p>

  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-top:10px;">
    <div style="min-width:220px;">
      <label class="muted">Report Channel (Chair Reports &amp; Receipts ZIP)</label>
      <select id="reportChannel" style="width:100%;height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px">
        <option value="auto" selected>Auto (use Order Channel)</option>
        <option value="test">Test</option>
        <option value="live_test">Live-Test</option>
        <option value="live">Live</option>
      </select>
    </div>
  </div>

  <div style="display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;margin-top:10px;">
    <label style="display:flex;gap:8px;align-items:center;">
      <input type="checkbox" id="zipMonthly" />
      <span>Monthly (previous month)</span>
    </label>

    <label style="display:flex;gap:8px;align-items:center;">
      <input type="checkbox" id="zipWeekly" />
      <span>Weekly (previous full week, UTC)</span>
    </label>

    <button class="btn" id="btnSaveZipPrefs" style="margin-left:auto;">Save</button>
  </div>

  <div class="muted" id="zipPrefsStatus" style="margin-top:10px;"></div>
</section>
      </div>
    </div>

<div class="row">
      <div class="col">
        <div class="card mb-12">
          <div class="section-label">Local Tools</div>
          <h3>
            Import / Export
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_import"
              aria-label="Help for Import and Export"
            >?</button>
          </h3>
          <p class="muted">Work offline by importing .json or .csv. This never overwrites data on the server.</p>
          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Import from file</label>
              <input id="fileImport" type="file" accept=".json,.csv" />
            </div>
          </div>
          <p class="muted mt-4">Use ‚ÄúExport Filtered (.xlsx)‚Äù above to download directly from the server with all filters applied.</p>
        </div>

        <!-- WEEKLY-ONLY AUTOMATION -->
        <div class="card mb-12">
          <div class="section-label">Automation</div>
          <h3>
            Automated Chair Reports
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_automation"
              aria-label="Help for Automated Chair Reports"
            >?</button>
          </h3>
          <p class="muted">
            Reports are sent <strong>weekly</strong> to banquet, add-on, and catalog chairs on the day you choose below.
          </p>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Weekly send day</label>
              <select id="reportWeekday">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="7">Sunday</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group" style="max-width:180px">
              <button id="btnSaveReportSettings" class="btn sm">Save Settings</button>
            </div>
            <div class="group">
              <span id="reportSettingsStatus" class="muted"></span>
            </div>
          </div>

          <p class="muted mt-4" id="reportSettingsHelp"></p>
        </div>

        <!-- Item tools -->
        <div class="card mb-12">
          <div class="section-label">Per-item tools</div>
          <h3>
            Download / Email by Specific Item
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_item_tools"
              aria-label="Help for Per-item Tools"
            >?</button>
          </h3>
          <p class="muted">Pick a category and item to download a focused report or email the chair directly.</p>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Category</label>
              <select id="actCategory">
                <option value="" selected disabled>Choose‚Ä¶</option>
                <option value="banquet">Banquets</option>
                <option value="addon">Add-ons</option>
                <option value="other">Catalog</option>
              </select>
            </div>
            <div class="group">
              <label class="muted">Item</label>
              <select id="actChoice">
                <option value="" selected disabled>Choose‚Ä¶</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group">
              <label class="muted">Email scope</label>
              <select id="scopeMode">
                <option value="full">Full (all orders for this item)</option>
                <option value="current-month">Month-to-date (from the 1st)</option>
                <option value="custom">Custom date range</option>
              </select>
            </div>
          </div>

          <div class="controls mt-4" id="scopeRangeRow" style="display:none">
            <div class="group">
              <label class="muted">Start date</label>
              <input id="scopeStart" type="date" />
            </div>
            <div class="group">
              <label class="muted">End date</label>
              <input id="scopeEnd" type="date" />
            </div>
          </div>

          <div class="controls mt-4">
            <div class="group" style="max-width:200px">
              <button id="btnActDownload" class="btn sm secondary">Download .xlsx</button>
            </div>
            <div class="group" style="max-width:200px">
              <button id="btnActEmail" class="btn sm">Email Chair(s)</button>
            </div>
          </div>
          <p class="muted mt-4" id="sendMsg"></p>
        </div>

        <div class="card">
          <div class="section-label">Quick totals</div>
          <h3>
            By Category
            <button
              type="button"
              class="help-btn"
              data-help-id="reporting_totals"
              aria-label="Help for Category Totals"
            >?</button>
          </h3>
          <p class="muted">Rough totals for the current filter window. For full accounting, use the exports above.</p>
          <div id="totalsByCategory" class="mt-8 text-sm muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Refund Modal -->
  <div id="refundModal" aria-hidden="true">
    <div class="modal-inner">
      <h4>Refund tools</h4>
      <p class="muted">Use ‚ÄúStripe Refund‚Äù if Stripe IDs are available, or ‚ÄúMark Refunded (Manual)‚Äù to track it in reports without touching Stripe.</p>

      <div class="border-top">
        <div class="text-xs muted">Suggested Refund Amount</div>
        <div style="font-size:18px;font-weight:700;margin-top:2px;" id="rfSuggested">$0.00</div>
        <div class="text-xs muted" id="rfSuggestedHint">This is Net + allocated fee for this item (order-level fee, cents-accurate).</div>
      </div>

      <div class="mt-8">
        <label class="muted">Stripe refund type</label>
        <select id="rfType" class="w-100" style="height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px">
          <option value="full">Full refund</option>
          <option value="partial">Partial amount</option>
        </select>
      </div>
      <div class="mt-4" id="rfAmtWrap" style="display:none">
        <label class="muted">Amount (USD)</label>
        <input id="rfAmount" type="number" min="0" step="0.01" class="w-100" style="height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px" />
      </div>

      <div class="mt-4">
        <label class="muted">Note (optional)</label>
        <input id="rfNote" type="text" class="w-100" placeholder="e.g., cancelled meal" style="height:32px;border-radius:8px;border:1px solid #d1d5db;padding:0 8px;font-size:13px" />
      </div>

      <p class="muted mt-4" id="rfInfo"></p>

      <div class="modal-actions">
        <button id="rfCancel" class="btn secondary sm">Close</button>
        <button id="rfManual" class="btn secondary sm">Mark Refunded (Manual)</button>
        <button id="rfSubmit" class="btn sm">Stripe Refund</button>
      </div>
    </div>
  </div>

  <!-- TEST CHAIR REPORT EMAILS -->
    <script>
    const LS_KEY = 'amaranth-report-rows-v1';
    let rows = [];
    let derivedRows = [];
    let manualRefundRecords = []; // loaded from server
    let manualRefundsByRowId = new Map(); // rowId -> record

    function asNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }


    function toCents(v){
      const n = Number(v || 0);
      if (!Number.isFinite(n)) return 0;
      return Math.round(n * 100);
    }
    function fromCents(c){
      const n = Number(c || 0);
      if (!Number.isFinite(n)) return 0;
      return n / 100;
    }

    function allocateFeeCentsAcrossItems(itemAmtsCents, feeTotalCents){
      // Proportional allocation with deterministic penny distribution.
      const n = itemAmtsCents.length;
      if (feeTotalCents <= 0 || n === 0) return new Array(n).fill(0);
      const subtotalCents = itemAmtsCents.reduce((s,c)=>s + (Number(c)||0), 0);
      if (subtotalCents <= 0){
        const base = Math.floor(feeTotalCents / n);
        let rem = feeTotalCents - base * n;
        return itemAmtsCents.map((_,i)=> base + (rem-- > 0 ? 1 : 0));
      }
      const alloc = new Array(n).fill(0);
      const rema = new Array(n).fill(0);
      let used = 0;
      for (let i=0;i<n;i++){
        const amt = Number(itemAmtsCents[i]) || 0;
        const numer = feeTotalCents * amt;
        const base = Math.floor(numer / subtotalCents);
        const rem = numer - base * subtotalCents;
        alloc[i] = base;
        rema[i] = rem;
        used += base;
      }
      let left = feeTotalCents - used;
      const idx = [...alloc.keys()].sort((a,b)=> rema[b] - rema[a]);
      for (let k=0; k<idx.length && left>0; k++){
        alloc[idx[k]] += 1;
        left--;
      }
      return alloc;
    }

    function getAmount(r){
      // Prefer explicit numeric fields already on the row.
      // (Your exports use different field names depending on source, so we support several.)
      if (r == null) return 0;

      // Common totals
      if (r.amount != null) return asNumber(r.amount);
      if (r.total != null) return asNumber(r.total);
      if (r.line_total != null) return asNumber(r.line_total);
      if (r.lineTotal != null) return asNumber(r.lineTotal);
      if (r.line_amount != null) return asNumber(r.line_amount);
      if (r.lineAmount != null) return asNumber(r.lineAmount);

      // Unit/qty derived totals
      if (r.unit_price != null && r.qty != null) return asNumber(r.unit_price) * asNumber(r.qty);
      if (r.unitPrice != null && r.qty != null) return asNumber(r.unitPrice) * asNumber(r.qty);
      if (r.price != null && r.qty != null) return asNumber(r.price) * asNumber(r.qty);

      // Cents variants
      if (r.amount_cents != null) return asNumber(r.amount_cents) / 100;
      if (r.total_cents != null) return asNumber(r.total_cents) / 100;
      if (r.line_total_cents != null) return asNumber(r.line_total_cents) / 100;
      if (r.lineTotalCents != null) return asNumber(r.lineTotalCents) / 100;
      if (r.unit_price_cents != null && r.qty != null) return (asNumber(r.unit_price_cents) / 100) * asNumber(r.qty);
      if (r.unitPriceCents != null && r.qty != null) return (asNumber(r.unitPriceCents) / 100) * asNumber(r.qty);

      return 0;
    }

    function normalizeStr(v){ return String(v||'').trim().toLowerCase(); }

    function isFeeRow(r){
      const cat = normalizeStr(r.category || r.type);
      const itemId = normalizeStr(r.item_id || r.itemId || r.sku || r.code);
      const itemName = normalizeStr(r.item || r.item_name || r.description);
      if (cat === 'fee' || cat === 'fees') return true;
      if (itemId === 'processing-fee' || itemId === 'intl-fee') return true;
      if (itemName.includes('processing fee') || itemName.includes('online processing fee')) return true;
      if (itemName.includes('international') && itemName.includes('fee')) return true;
      return false;
    }

    
    // Some exports include a second "other" row for Online Processing Fee with no item id.
    // We keep the real fee rows (processing-fee, intl-fee) and drop only the duplicate "other" one.
    function isDuplicateOtherFeeRow(r){
      const cat = normalizeStr(r.category || r.type);
      if (cat !== 'other') return false;
      const itemId = normalizeStr(r.item_id || r.itemId || r.sku || r.code);
      if (itemId) return false;
      const itemName = normalizeStr(r.item || r.item_name || r.description);
      if (!itemName) return false;
      const isProc = itemName.includes('processing fee') || itemName.includes('online processing fee');
      const isIntl = itemName.includes('international') && itemName.includes('fee');
      return isProc && !isIntl;
    }

function getOrderKey(r){
      return r.order_id || r.orderId || r.session_id || r.sessionId || r.id || '';
    }

    function stableISODate(r){
      const v = r.date || r.created || r.created_at || r.createdAt || '';
      const t = Date.parse(v);
      if (isNaN(t)) return '';
      return new Date(t).toISOString();
    }

    function getItemId(r){
      return String(r.item_id || r.itemId || r.sku || r.code || '').trim();
    }

    // RowId is the stable match key for manual refunds.
    // It tries to be deterministic across reloads and exports.
    function makeRowId(r){
      const orderKey = getOrderKey(r) || '';
      const itemId = getItemId(r) || '';
      const buyer = (r._buyer || r.buyer_name || r.purchaser_name || r.purchaser || r.buyer || r.name || r.customer_name || '').trim();
      const iso = stableISODate(r);
      const amtCents = toCents(getAmount(r));
      // include attendee when present (banquets/addons)
      const attendee = String(r.attendee || r.attendee_name || r.attendeeName || '').trim();
      return [orderKey, itemId, buyer, attendee, iso, String(amtCents)].join('|');
    }

    function getBuyerDisplay(r){
      return (
        r.buyer_name ||
        r.purchaser_name ||
        r.purchaser ||
        r.buyer ||
        r.name ||
        r.customer_name ||
        '‚Äî'
      );
    }

    function recomputeDerivedRows(){
      // Build a display-only view where fee line items are allocated across real items.
      // This avoids double "processing fee" rows and gives per-item Gross/Net.
      const groups = new Map();
      (rows || []).forEach(r=>{
        const key = getOrderKey(r);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      });

      const out = [];
      for (const [key, group] of groups.entries()){
        const feeRows = group.filter(isFeeRow);
        const itemRows = group.filter(r=>!isFeeRow(r));

        const feeTotal = feeRows.reduce((s,r)=>s+getAmount(r),0);
        const subtotal = itemRows.reduce((s,r)=>s+getAmount(r),0);
        const nItems = itemRows.length || 0;

        // Cents-accurate allocation of order-level fee across item rows (deterministic pennies).
        const itemAmtsCents = itemRows.map(r=>toCents(getAmount(r)));
        const feeTotalCents = toCents(feeTotal);
        const allocCentsArr = allocateFeeCentsAcrossItems(itemAmtsCents, feeTotalCents);

        itemRows.forEach((r,i)=>{
          const amtCents = itemAmtsCents[i] || 0;
          const allocCents = allocCentsArr[i] || 0;

          const buyer = getBuyerDisplay(r);
          // attach derived fields (safe, UI-only)
          r._buyer = buyer;
          r._rowId = makeRowId(r);
          r._amount = fromCents(amtCents);
          r._feeAlloc = fromCents(allocCents);
          r._refund = fromCents(amtCents + allocCents); // what to refund to stay fee-neutral (based on allocated fee)
          r._gross = r._refund; // legacy alias
          r._net = fromCents(amtCents); // chairman payout when purchaser pays fee
          out.push(r);
        });


        // Re-add fee rows (one processing fee + optional international fee) so they show in the table.
        // Drop the duplicate "other Online Processing Fee" row that has no item id.
        feeRows.forEach(r=>{
          try{
            if (typeof isDuplicateOtherFeeRow === 'function' && isDuplicateOtherFeeRow(r)) return;
          }catch(e){}
          const amt = getAmount(r);
          const buyer = getBuyerDisplay(r);
          r._buyer = buyer;
          r._rowId = makeRowId(r);
          r._amount = amt;
          r._feeAlloc = 0;
          r._refund = NaN;
          r._gross = amt;
          r._net = amt;
          out.push(r);
        });


        // Add an audit line for each manual refund record on this order (admin-only).
        if (manualRefundRecords && manualRefundRecords.length){
          for (const rec of manualRefundRecords){
            if (!rec) continue;
            if (String(rec.orderId || rec.order_id || '') !== String(key)) continue;

            out.push({
              date: rec.markedAt ? new Date(rec.markedAt).toISOString() : (rec.createdAt || ''),
              buyer: (rec.buyer || ''),
              email: '',
              item: `REMOVED/REFUNDED: ${rec.itemName || rec.item || '(item)'}${rec.qty ? (' √ó' + rec.qty) : ''}`,
              notes: rec.note || '',
              category: 'note',
              status: 'refunded',
              amount: 0,
              order_id: key,
              _buyer: rec.buyer || '‚Äî',
              _amount: 0,
              _feeAlloc: 0,
              _refund: NaN,
              _gross: 0,
              _net: 0,
              _rowId: String(rec.rowId || ''),
            });
          }
        }
      }

      derivedRows = out;
    }

    function $(sel){ return document.querySelector(sel); }

    function loadFromLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed)? parsed: [];
      }catch(e){
        console.warn('Failed to load local rows', e);
        return [];
      }
    }
    function saveToLocal(data){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(data || []));
      }catch(e){}
    }

    function buildServerQuery(extra){
      const params = new URLSearchParams();
      const df = $('#dateFrom').value;
      const dt = $('#dateTo').value;
      const cat = $('#category').value;
      const st  = $('#status').value;
      const q   = $('#search').value.trim();
      if (df) params.set('from', df);
      if (dt) params.set('to', dt);
      if (cat) params.set('category', cat);
      if (st) params.set('status', st);
      if (q) params.set('search', q);
      if (extra && typeof extra === 'object') {
        for (const [k,v] of Object.entries(extra)){
          if (v !== undefined && v !== '') params.set(k, v);
        }
      }
      if (typeof extra === 'string' && extra) {
        // allow passing pre-built query strings from per-item tools
        return extra.startsWith('?') ? extra : ('?' + extra);
      }
      return params.toString() ? '?' + params.toString() : '';
    }

    function render(){
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      const df = $('#dateFrom').value;
      const dt = $('#dateTo').value;
      const cat = $('#category').value;
      const st  = $('#status').value;
      const q   = $('#search').value.trim().toLowerCase();

      const fromMs = df ? Date.parse(df + 'T00:00:00Z') : NaN;
      const toMs   = dt ? Date.parse(dt + 'T23:59:59Z') : NaN;

      let filtered = (derivedRows && derivedRows.length ? derivedRows : rows).slice();
      filtered = filtered.filter(r=>{
        const t = Date.parse(r.date || r.created || r.created_at || '');
        if (!isNaN(fromMs) && t < fromMs) return false;
        if (!isNaN(toMs) && t > toMs) return false;
        if (cat && String(r.category||'').toLowerCase() !== cat.toLowerCase()) return false;
        if (st && String(r.status||'').toLowerCase() !== st.toLowerCase()) return false;
        if (q){
          const hay = [
            r.name,r.buyer,r.email,r.item,r.item_name,
            r.address,r.city,r.state,r.zip,r.country,
            r.phone,r.notes,r.metadata && JSON.stringify(r.metadata)
          ].join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      filtered.sort((a,b)=>{
        const ta = Date.parse(a.date || a.created || a.created_at || '')||0;
        const tb = Date.parse(b.date || b.created || b.created_at || '')||0;
        return ta - tb;
      });

      let maxRows = Infinity;
      const limitEl = $('#rowsLimit');
      if (limitEl){
        if (limitEl.value !== 'all'){
          const n = parseInt(limitEl.value,10);
          if (n > 0) maxRows = n;
        }
      }

      let idx = 0, shown = 0;
      let gross = 0;
      let netTotal = 0;
      let feeTotal = 0;
      let refundedAmt = 0;
      let paid=0,pending=0,refunded=0;
      const byCat = {};

      for (const r of filtered){
        idx++;
        const status = (r.status||'').toLowerCase();
        if (isDuplicateOtherFeeRow(r)) continue;

        const isFee = isFeeRow(r);
        const amt = getAmount(r);

        // Fee rows: show amount under Net, and show Refund as ‚Äî
        const netAmount = isFee ? amt : (Number.isFinite(r._net) ? r._net : amt);
        const feeAlloc = isFee ? 0 : (Number.isFinite(r._feeAlloc) ? r._feeAlloc : 0);
        const refundAmount = isFee ? NaN : (Number.isFinite(r._refund) ? r._refund : (Number.isFinite(r._gross) ? r._gross : (netAmount + feeAlloc)));

        if (status === 'paid') paid++;
        else if (status === 'pending') pending++;
        else if (status === 'refunded') refunded++;

        const g = isFinite(refundAmount) ? refundAmount : 0;
        const n = isFinite(netAmount) ? netAmount : 0;
        const f = isFinite(feeAlloc) ? feeAlloc : 0;
        if (status === 'refunded'){
          refundedAmt += n;
          // refunded items should not count toward totals
        }else{
          if (!isFee){
            gross += g;
            netTotal += n;
            feeTotal += f;
          }
        }

        const catKey = String(r.category||r.type||'other').toLowerCase();
        byCat[catKey] = byCat[catKey] || {total:0,count:0};
        if (status !== 'refunded' && !isFee){
          byCat[catKey].total += n;
          byCat[catKey].count++;
        }

        if (shown >= maxRows) continue;
        shown++;

        const tr = document.createElement('tr');

        function td(text,cls){
          const el=document.createElement('td');
          if(cls)el.className=cls;
          el.innerHTML=text;
          return el;
        }

        const t = Date.parse(r.date||r.created||r.created_at||'');
        const dateStr = isNaN(t)?'‚Äî':new Date(t).toLocaleString();

        const buyer = r._buyer || r.buyer_name || r.purchaser_name || r.purchaser || r.buyer || r.name || r.customer_name || '‚Äî';
        const item  = r.item||r.item_name||r.description||'‚Äî';

        const metaBits=[];
        if(r.phone)metaBits.push(`üìû ${r.phone}`);
        if(r.city||r.state)metaBits.push(`üìç ${[r.city,r.state].filter(Boolean).join(', ')}`);
        if(r.order_id||r.id)metaBits.push(`ID: ${r.order_id||r.id}`);

        const cells = [
          td(idx,'text-xs muted'),
          td(dateStr,'text-xs'),
          td(`<div class="text-xs">${buyer}</div><div class="text-xs muted">${r.email||''}</div>`),
          td(`<div class="text-xs">${item}</div><div class="text-xs muted">${r.notes||r.memo||''}</div>`),
          td(`<span class="badge-sm tag-muted">${r.category||r.type||'‚Äî'}</span>`),
          td(`<span class="status-icon ${status}">
                <span class="dot"></span>
                <span>${status||'unknown'}</span>
              </span>`),
          td(isFinite(netAmount)?'$'+netAmount.toFixed(2):'‚Äî','text-right text-xs'),

          td(isFinite(refundAmount)?'$'+refundAmount.toFixed(2):'‚Äî','text-right text-xs'),
          td(metaBits.map(x=>`<div class="text-xs muted">${x}</div>`).join(''))
        ];
        cells.forEach(c=>tr.appendChild(c));

        tr.addEventListener('click',()=>{
          const pi=r.payment_intent||r.pi;
          const ch=r.charge||r.charge_id;
          openRefundModal({
            payment_intent:pi,
            charge:ch,
            total:netAmount,
            refund:isFinite(refundAmount)?refundAmount:netAmount,
            orderKey:getOrderKey(r),
            item:(r.item||r.item_name||r.description||''),
            buyer:(r._buyer||buyer||''),
            row:r
          });
        });

        tbody.appendChild(tr);
      }

      if(filtered.length===0) $('#totalCount').textContent='0';
      else if(shown>=filtered.length || !Number.isFinite(maxRows))
        $('#totalCount').textContent=String(filtered.length);
      else
        $('#totalCount').textContent=`${shown} / ${filtered.length}`;

      const net = netTotal;
      const grossEl = document.getElementById('grossAmount');
      const netEl = document.getElementById('netAmount');
      if (grossEl) grossEl.textContent = '$' + gross.toFixed(2);
      if (netEl) netEl.textContent = '$' + net.toFixed(2);
      $('#paidCount').textContent = paid;
      $('#pendingCount').textContent = pending;
      $('#refundedCount').textContent = refunded;

      const totalsDiv = $('#totalsByCategory');
      totalsDiv.innerHTML='';
      const cats = Object.entries(byCat);
      if(!cats.length){
        totalsDiv.textContent='No rows in current filter window.';
      } else {
        cats.forEach(([catKey,info])=>{
          const line=document.createElement('div');
          line.className='mb-4';
          line.innerHTML=
            `<span class="pill tag-muted">${catKey}</span>
             <span class="text-xs muted">Count: ${info.count}</span>
             <span class="text-xs muted"> ‚Ä¢ Total: $${info.total.toFixed(2)}</span>`;
          totalsDiv.appendChild(line);
        });
      }
    }

    async function loadManualRefundsForOrderIds(orderIds){
      try{
        const uniq = Array.from(new Set((orderIds||[]).filter(Boolean)));
        if (!uniq.length){
          manualRefundRecords = [];
          manualRefundsByRowId = new Map();
          return;
        }
        const r = await fetch('/api/router?action=get_manual_refunds', {
          method:'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ orderIds: uniq })
        });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(j?.error || j?.message || ('HTTP '+r.status));
        const recs = Array.isArray(j.records) ? j.records : (Array.isArray(j.manualRefunds) ? j.manualRefunds : []);
        manualRefundRecords = recs || [];
        manualRefundsByRowId = new Map();
        for (const rec of manualRefundRecords){
          if (rec && rec.rowId) manualRefundsByRowId.set(String(rec.rowId), rec);
        }
      }catch(e){
        // If the router action isn't deployed yet, we stay silent and keep going.
        manualRefundRecords = [];
        manualRefundsByRowId = new Map();
      }
    }

    function applyManualRefundMarks(){
      if (!manualRefundsByRowId || manualRefundsByRowId.size === 0) return;

      // Mark matching base rows as refunded (so they disappear from totals).
      for (const r of (rows || [])){
        const rowId = r._rowId || makeRowId(r);
        r._rowId = rowId;
        const rec = manualRefundsByRowId.get(rowId);
        if (!rec) continue;

        r.status = 'refunded';
        const note = String(rec.note || '').trim();
        const prefix = 'REFUNDED (manual)' + (note ? (': ' + note) : '');
        const existing = String(r.notes || r.memo || '');
        const combined = existing ? (prefix + ' ‚Ä¢ ' + existing) : prefix;
        r.notes = combined;
      }
    }

    async function loadFromServer(){
      try{
        const qs = buildServerQuery();
        const r = await fetch('/api/router?type=orders'+qs,{cache:'no-store'});
        const j = await r.json();
        if(!r.ok) throw new Error(j?.error||'Fetch failed');
        rows = Array.isArray(j.rows)?j.rows:[];
        // Load and apply manual refund marks from KV
        await loadManualRefundsForOrderIds(rows.map(getOrderKey));
        applyManualRefundMarks();
        saveToLocal(rows);
        recomputeDerivedRows();
        render();
      }catch(e){
        rows = loadFromLocal();
        await loadManualRefundsForOrderIds(rows.map(getOrderKey));
        applyManualRefundMarks();
        recomputeDerivedRows();
        render();
      }
    }

    document.getElementById('fileImport').addEventListener('change', async e=>{
      const file=e.target.files[0]; if(!file)return;
      const text=await file.text();
      let data=[];
      try{
        if(file.name.endsWith('.json') || text.trim().startsWith('['))
          data=JSON.parse(text);
      }catch(err){alert('Failed to parse');return;}
      rows = Array.isArray(data)?data:[];
      saveToLocal(rows);
      render();
      e.target.value='';
    });

    document.getElementById('btnExportCsv').addEventListener('click', async ()=>{
      const qs=buildServerQuery();
      await downloadServerCsv(qs);
    });

    document.getElementById('btnFullAttendeesCsv').addEventListener('click', async ()=>{
      const qs=buildServerQuery();
      await downloadServerCsv(qs);
    });

    async function downloadServerCsv(qs){
      // qs is typically returned like "?start=YYYY-MM-DD&end=YYYY-MM-DD&category=..."
      // but this endpoint already has "?type=orders_csv" so we must join with "&".
      if (typeof qs === 'string' && qs){
        if (qs.startsWith('?')) qs = '&' + qs.slice(1);
        else if (!qs.startsWith('&')) qs = '&' + qs;
      } else {
        qs = '';
      }
      return downloadCsvFrom('/api/router?type=orders_csv'+qs,'amaranth-report');
    }

    async function downloadCsvFrom(url,namePrefix){
      try{
        const r=await fetch(url,{cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const blob=await r.blob();
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`${namePrefix}-${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a); a.click(); a.remove();
        return true;
      }catch(e){
        alert('Download failed');
      }
    }

    document.getElementById('btnPrint').addEventListener('click',()=>window.print());

    document.getElementById('btnClear').addEventListener('click',()=>{
      if(prompt('Type CLEAR to remove only local rows')==='CLEAR'){
        localStorage.removeItem(LS_KEY);
        rows=[];
        render();
      }
    });

    document.getElementById('btnSample').addEventListener('click',()=>{
      rows=[]; // keeping sample off
      render();
    });

    ['dateFrom','dateTo','category','status','search','rowsLimit']
      .forEach(id=>document.getElementById(id)?.addEventListener('input',render));

    const caches={banquet:null,addon:null,other:null};

    function normalizeList(kind,list){
      return (list||[]).map(x=>({
        id:String(x.id||x.itemId||x.slug||x.code||x.name||''),
        name:String(x.name||x.title||x.label||x.slug||x.id||'(unnamed)'),
        chairEmails:Array.isArray(x.chairEmails)?x.chairEmails
          :String(x.chairEmails||x.chairs||'').split(',').map(s=>s.trim()).filter(Boolean)
      }));
    }

    async function fetchList(kind){
      if(caches[kind]) return caches[kind];
      const typeMap={banquet:'banquets',addon:'addons',other:'products'};
      const listType=typeMap[kind];
      let list=[];
      try{
        const r=await fetch(`/api/router?type=${listType}`,{cache:'no-store'});
        if(r.ok){
          const j=await r.json();
          list=normalizeList(kind,j[listType]);
        }
      }catch{}
      caches[kind]=list;
      return list;
    }

    document.getElementById('actCategory').addEventListener('change',async()=>{
      const kind=$('#actCategory').value;
      const list=await fetchList(kind);
      const sel=$('#actChoice');
      sel.innerHTML='<option value="" disabled selected>Choose‚Ä¶</option>';
      list.forEach(it=>{
        const opt=document.createElement('option');
        opt.value=it.id;
        opt.dataset.label=it.name;
        opt.textContent=it.name+(it.chairEmails.length?' ‚Äî '+it.chairEmails.join(', '):'');
        sel.appendChild(opt);
      });
    });

    $('#scopeMode').addEventListener('change',()=>{
      $('#scopeRangeRow').style.display =
        $('#scopeMode').value==='custom' ? 'flex' : 'none';
    });

    document.getElementById('btnActDownload').addEventListener('click',async()=>{
      const kind=$('#actCategory').value;
      const opt=$('#actChoice').selectedOptions[0];
      if(!kind)return alert('Choose category');
      if(!opt)return alert('Choose item');
      const id=opt.value;
      const label=opt.dataset.label;
      const extra = new URLSearchParams({
        category:kind,
        item_id:id,
        item:label
      }).toString();
      await downloadServerCsv(extra);
    });

    document.getElementById('btnActEmail').addEventListener('click',async()=>{
      const kind=$('#actCategory').value;
      const opt=$('#actChoice').selectedOptions[0];
      if(!kind)return alert('Choose category');
      if(!opt)return alert('Choose item');
      const id=opt.value;
      const label=opt.dataset.label;
      const scopeMode=$('#scopeMode').value;

      const payload={
        kind,
        id,
        label,
        scope: scopeMode,
        channel: String(document.getElementById('reportChannel')?.value || 'auto'),
      };
      if(scopeMode==='custom'){
        const s=$('#scopeStart').value;
        const e=$('#scopeEnd').value;
        if(!s||!e)return alert('Both dates required');
        payload.startYMD=s; payload.endYMD=e;
      }

      $('#sendMsg').textContent='Sending‚Ä¶';
      try{
        const r=await fetch('/api/router?action=send_item_report',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const j=await r.json();
        if(!r.ok) throw new Error(j?.error||j?.message||'Failed');
        $('#sendMsg').textContent=`Email queued. (${j.count||0} rows)`;
      }catch(e){
        $('#sendMsg').textContent='Send failed: '+e.message;
      }
    });

    let currentRefundCtx=null;

    function openRefundModal(ctx){
      currentRefundCtx = ctx || null;

      // Reset UI
      $('#rfType').value = 'full';
      $('#rfAmount').value = '';
      $('#rfAmtWrap').style.display = 'none';
      if ($('#rfNote')) $('#rfNote').value = '';

      const suggested = Number(ctx?.refund || 0);
      if (document.getElementById('rfSuggested')){
        document.getElementById('rfSuggested').textContent = '$' + (isFinite(suggested) ? suggested.toFixed(2) : '0.00');
      }

      const pi = ctx?.payment_intent || '';
      const ch = ctx?.charge || '';
      const hasStripe = !!pi || !!ch;

      const infoParts = [];
      infoParts.push(`Order: ${ctx?.orderKey || '‚Äî'}`);
      if (ctx?.buyer) infoParts.push(`Buyer: ${ctx.buyer}`);
      if (ctx?.item) infoParts.push(`Item: ${ctx.item}`);
      infoParts.push(`Stripe PI: ${pi || '‚Äî'}  Charge: ${ch || '‚Äî'}`);

      if (!hasStripe){
        infoParts.push('Stripe IDs not found for this row. Use ‚ÄúMark Refunded (Manual)‚Äù and refund in Stripe by entering the amount yourself.');
      }else{
        infoParts.push('Stripe IDs found. You can also use ‚ÄúStripe Refund‚Äù from here.');
      }

       $('#rfInfo').textContent = infoParts.join('\n');

      const submit = document.getElementById('rfSubmit');
      if (submit){
        submit.disabled = !hasStripe;
        submit.style.opacity = hasStripe ? '1' : '.45';
        submit.style.cursor = hasStripe ? 'pointer' : 'not-allowed';
      }

      $('#refundModal').style.display='flex';
      $('#refundModal').setAttribute('aria-hidden','false');
    }

    function closeRefundModal(){
$('#refundModal').style.display='none';
      $('#refundModal').setAttribute('aria-hidden','true');
      currentRefundCtx=null;
    }

    $('#rfType').addEventListener('change',()=>{
      $('#rfAmtWrap').style.display = $('#rfType').value==='partial'?'block':'none';
    });
    $('#rfCancel').addEventListener('click',closeRefundModal);

    // Manual refund marker (does NOT call Stripe). This is for tracking and chair reports.
    $('#rfManual')?.addEventListener('click', async ()=>{
      if(!currentRefundCtx || !currentRefundCtx.row) return;

      const note = ($('#rfNote')?.value || '').trim();
      // 1) Update local row status so it disappears from totals (and can be filtered as refunded)
      try{
        currentRefundCtx.row.status = 'refunded';
        const prefix = note ? ('REFUNDED: ' + note) : 'REFUNDED';
        const existing = String(currentRefundCtx.row.notes || currentRefundCtx.row.memo || '');
        const combined = existing ? (prefix + ' ‚Ä¢ ' + existing) : prefix;
        if (currentRefundCtx.row.notes != null) currentRefundCtx.row.notes = combined;
        else currentRefundCtx.row.notes = combined;
        saveToLocal(rows);
      }catch(e){}

      // 2) Best-effort persist to server (requires router action; safe to fail until added)
      try{
        const headers = getAuthHeaders();
        const payload = {
          orderId: currentRefundCtx.orderKey || getOrderKey(currentRefundCtx.row),
          rowId: currentRefundCtx.row?._rowId || makeRowId(currentRefundCtx.row),
          itemId: getItemId(currentRefundCtx.row),
          itemName: currentRefundCtx.item || (currentRefundCtx.row.item || currentRefundCtx.row.item_name || currentRefundCtx.row.description || ''),
          qty: 1,
          createdAt: currentRefundCtx.row.date || currentRefundCtx.row.created || currentRefundCtx.row.created_at || null,
          note,
          markedAt: Date.now(),
          // Admin-only convenience field (not required by router)
          suggestedRefundCents: Math.round(Number(currentRefundCtx.refund || 0) * 100),
        };
        await fetch('/api/router?action=mark_manual_refund', {
          method:'POST',
          headers,
          body: JSON.stringify(payload)
        });
      }catch(e){
        // ignore until router is wired
      }

      recomputeDerivedRows();
      render();
      closeRefundModal();
      alert('Marked refunded (manual). Now refund in Stripe using the Suggested Refund Amount.');
    });

    $('#rfSubmit').addEventListener('click',async()=>{
      if(!currentRefundCtx)return;
      const headers={'Content-Type':'application/json'};
      const token=localStorage.getItem('amaranth_report_token');
      if(token)headers.Authorization='Bearer '+token;

      let amount_cents;
      if($('#rfType').value==='partial'){
        const v=Number($('#rfAmount').value||0);
        if(!isFinite(v)||v<=0)return alert('Enter amount');
        amount_cents=Math.round(v*100);
      }
      const payload={
        payment_intent:currentRefundCtx.payment_intent,
        charge:currentRefundCtx.charge,
        ...(amount_cents?{amount_cents}:{})
      };

      try{
        const r=await fetch('/api/router?action=create_refund',{
          method:'POST',headers,body:JSON.stringify(payload)
        });
        const j=await r.json();
        if(!r.ok) throw new Error(j?.error||'Failed');
        alert('Refund created');
        closeRefundModal();
        loadFromServer();
      }catch(e){
        alert('Refund failed: '+e.message);
      }
    });

    function getAuthHeaders(){
      const token=localStorage.getItem('amaranth_report_token')||'';
      const headers={'Content-Type':'application/json'};
      if(token) headers.Authorization='Bearer '+token;
      return headers;
    }

    async function loadReportSettings(){
      const statusEl=$('#reportSettingsStatus');
      const helpEl=$('#reportSettingsHelp');
      try{
        const r=await fetch('/api/router?action=get_settings',{
          method:'POST',headers:getAuthHeaders(),body:JSON.stringify({})
        });
        const j=await r.json();
        if(!r.ok||!j.ok) throw new Error(j?.error||j?.message||'Failed');

        const weekday=String(j.effective?.REPORT_WEEKDAY||'1');
        $('#reportWeekday').value=weekday;
        statusEl.textContent='';
        helpEl.textContent=`Weekly reports will be sent every ${$('#reportWeekday').selectedOptions[0].textContent}.`;
      }catch{
        statusEl.textContent='Could not load settings.';
        helpEl.textContent='';
      }
    }

    $('#btnSaveReportSettings').addEventListener('click',async()=>{
      const weekday=$('#reportWeekday').value;
      const statusEl=$('#reportSettingsStatus');
      statusEl.textContent='Saving‚Ä¶';
      try{
        const r=await fetch('/api/router?action=save_settings',{
          method:'POST',
          headers:getAuthHeaders(),
          body:JSON.stringify({
            REPORT_FREQUENCY:'weekly',
            REPORT_WEEKDAY:weekday
          })
        });
        const j=await r.json();
        if(!r.ok||!j.ok) throw new Error(j?.error||j?.message||'Failed');
        statusEl.textContent='Saved.';
        $('#reportSettingsHelp').textContent=
          `Weekly reports will be sent every ${$('#reportWeekday').selectedOptions[0].textContent}.`;
      }catch(e){
        statusEl.textContent='Save failed: '+e.message;
      }
    });

    
    // Send test chair report emails immediately (does not affect scheduled sends)
    $('#btnSendTestReports')?.addEventListener('click', async () => {
      const out = $('#testReportOut');
      if (out) out.textContent = 'Running test‚Ä¶';

      try {
        const payload = {
          to: ($('#testReportTo')?.value || 'kfors@verizon.net').trim(),
          frequency: ($('#testReportFreq')?.value || 'monthly').trim(),
          scope: ($('#testReportScope')?.value || 'current-month').trim(),
          previewOnly: !!$('#testPreviewOnly')?.checked,
          channel: String(document.getElementById('reportChannel')?.value || 'auto'),
        };

        const r = await fetch('/api/router?action=send_test_chair_reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify(payload),
        });

        const j = await r.json().catch(() => ({}));
        if (!r.ok || !j.ok) throw new Error(j?.error || j?.message || ('HTTP ' + r.status));

        if (out) out.textContent = JSON.stringify(j, null, 2);
      } catch (e) {
        if (out) out.textContent = 'ERROR: ' + (e?.message || String(e));
      }
    });

(function init(){
      rows=loadFromLocal();
      // Load manual refund marks for local cache, then refresh from server
      loadManualRefundsForOrderIds(rows.map(getOrderKey)).then(()=>{
        applyManualRefundMarks();
        recomputeDerivedRows();
        render();
      });
      loadFromServer();
      loadReportSettings();
    })();
  </script>
  



<!-- Shared help popup logic -->
  <script src="/assets/js/admin.js"></script>
  <script src="/assets/js/admin-help.js"></script>
  <script>
// ---------------- Receipts ZIP prefs ----------------
function normalizeChannelValue(v){
  const s = String(v || 'auto').trim();
  if (!s) return 'auto';
  if (s === 'live-test' || s === 'live_test' || s === 'livetest') return 'live_test';
  if (s === 'test') return 'test';
  if (s === 'live') return 'live';
  if (s === 'auto') return 'auto';
  return s;
}
function toBool(v){
  return v === true || v === 'true' || v === 1 || v === '1' || v === 'on';
}

async function loadOrderChannelLabel() {
  try {
    const r = await fetch("/api/router?type=settings", { headers: Admin.tokenHeader() });
    const j = await r.json();
    const ch = j?.json?.settings?.ORDER_CHANNEL || j?.settings?.ORDER_CHANNEL || j?.ORDER_CHANNEL;
    const el = document.getElementById("orderChannelLabel");
    if (el) el.textContent = ch || "unknown";
  } catch {}
}

async function loadZipPrefs() {
  const status = document.getElementById("zipPrefsStatus");
  try {
    const r = await fetch("/api/router?type=receipts_zip_prefs", { headers: Admin.tokenHeader() });
    const j = await r.json();
    const payload = j?.json || j;

    // ‚úÖ Your API shape (from your console):
    // {
    //   ok:true,
    //   prefs:{ channel:"auto", receiptZip:{monthly:false, weekly:false}},
    //   mode:"live"
    // }
    const selectedChannel = normalizeChannelValue(payload?.prefs?.channel || payload?.channel || 'auto');
    const resolvedMode = normalizeChannelValue(payload?.mode || payload?.resolvedMode || selectedChannel);

    const rz = payload?.prefs?.receiptZip || payload?.prefs?.receipt_zip || payload?.receiptZip || payload?.prefs || {};
    const monthly = toBool(rz?.monthly);
    const weekly  = toBool(rz?.weekly);

    const mEl = document.getElementById("zipMonthly");
    const wEl = document.getElementById("zipWeekly");
    if (mEl) mEl.checked = !!monthly;
    if (wEl) wEl.checked = !!weekly;

    const chEl = document.getElementById('reportChannel');
    if (chEl) chEl.value = selectedChannel;

    if (status) {
      status.textContent =
        `Loaded. Selected=${selectedChannel} ‚Ä¢ Using=${resolvedMode} ‚Ä¢ Monthly=${monthly ? "on" : "off"} ‚Ä¢ Weekly=${weekly ? "on" : "off"}`;
    }
  } catch (e) {
    if (status) status.textContent = "Could not load (check admin token).";
  }
}

async function saveZipPrefs() {
  const status = document.getElementById("zipPrefsStatus");
  const monthly = !!document.getElementById("zipMonthly")?.checked;
  const weekly  = !!document.getElementById("zipWeekly")?.checked;
  const channel = normalizeChannelValue(document.getElementById('reportChannel')?.value || 'auto');

  try {
    if (status) status.textContent = "Saving‚Ä¶";

    // Send in the shapes your backend is clearly using (prefs.channel + prefs.receiptZip).
    // Also include flat keys for backward compatibility (some older versions expected monthly/weekly at top level).
    const body = {
      channel,
      mode: channel, // harmless if ignored; some server code used "mode"
      prefs: {
        channel,
        receiptZip: { monthly, weekly }
      },
      receiptZip: { monthly, weekly },
      monthly,
      weekly
    };

    const r = await fetch("/api/router?action=set_receipts_zip_prefs", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...Admin.tokenHeader() },
      body: JSON.stringify(body)
    });

    const j = await r.json().catch(()=>({}));
    if (!r.ok || (!j?.ok && !j?.json?.ok)) throw new Error(j?.error || j?.json?.error || "save failed");

    if (status) status.textContent = "Saved. Reloading‚Ä¶";
    await loadZipPrefs();
  } catch (e) {
    if (status) status.textContent = "Save failed (check admin token).";
  }
}

document.getElementById("btnSaveZipPrefs")?.addEventListener("click", saveZipPrefs);
loadOrderChannelLabel();
loadZipPrefs();


</script>
</body>
</html>
