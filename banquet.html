<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Banquets and related items for registration.">
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="assets/css/styles.css?v=banquets-v14"><!-- bump -->
  <title>Banquets</title>
</head>

<body data-page="banquets">
  <div class="wallpaper" style="--wallpaper: url('/assets/img/wallpaper.jpg')"></div>

  <!-- Header / Logo + Nav -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="home.html">
        <img src="assets/img/logo.svg" alt="Logo">
      </a>
      <span class="site-title">Order of the Amaranth</span>
      <nav class="site-nav nav">
        <a href="home.html">Home</a>
        <span class="nav-current">Banquets</span>
        <a href="supreme-addons.html">Supreme Council Add-Ons</a>
        <!-- <a href="product-catalog.html" data-catalog-link>Product Catalog</a> -->
        
        <!-- TEMP: hide Supplies everywhere (weâ€™ll re-enable later) -->
        <a href="supplies.html">Supplies</a>

        <!-- <a href="charity.html" data-cat-link data-cat="charity">Charity</a> -->

        <a href="order.html">Cart</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <main class="container mt-lg">
    <h1 class="page-title">Banquets</h1>

    <div id="banquet-list" class="grid-2"></div>



    <!-- ===== BEFORE YOU BEGIN ===== -->
    <section class="card" style="margin-top:16px;">
      <h3>Before You Begin</h3>
      <p>Please <strong>add all attendees first</strong> before selecting items.</p>
      <p>Many banquets and add-ons are <strong>assigned to a specific attendee</strong>. Be sure to select the correct attendee when making each selection. Some items may be limited to <strong>one per person</strong>, while others allow <strong>multiple quantities</strong>.</p>
      <p>Each attendee includes a <strong>Dietary Notes</strong> field. Use this space to list allergies, dietary restrictions, or special requests (for example: vegetarian, gluten-free, no nuts). These notes are reviewed by the appropriate chairperson.</p>
      <p>If the same item is needed for more than one person, please select it <strong>separately for each attendee</strong>.</p>
    </section>
    <!-- ============================= -->
    <!-- Attendees section -->
    <section class="card" style="background:rgba(255,255,255,0.40);backdrop-filter:saturate(120%) blur(2px);-webkit-backdrop-filter:saturate(120%) blur(2px);border:1px solid rgba(229,231,235,0.45);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;">
      <h2>Attendees</h2>
      <form id="attForm" class="att-form" autocomplete="off">
        <div class="grid-3">
          <input name="name"  placeholder="Name *" required>
          <input name="email" type="email" placeholder="Email *" required>
          <input name="phone" type="tel" inputmode="tel" placeholder="Phone *" required>
        </div>
        <div class="grid-3">
          <input name="courtName" placeholder="Court Name *" required>
          <input name="courtNumber" placeholder="Court # *" required>
          <input name="jurisdiction" placeholder="Jurisdiction *" required>
        </div>
        <div class="grid-3">
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div style="font-weight:700;">Membership *</div>
            <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
              <label style="display:flex;gap:6px;align-items:center;">
                <input type="radio" name="memberType" value="voting" required> Voting
              </label>
              <label style="display:flex;gap:6px;align-items:center;">
                <input type="radio" name="memberType" value="non_voting" required> Non-Voting
              </label>
            </div>
          </div>
          <span></span>
          <span></span>
        </div>
        <div class="grid-3">
          <!-- Title required -->
          <input name="title" placeholder="Title *" required>
          <input name="notes" placeholder="Dietary notes">
          <input name="addr1" placeholder="Address line 1 *" required>
        </div>
        <div class="grid-3">
          <input name="addr2" placeholder="Address line 2">
          <input name="city" placeholder="City *" required>
          <input name="state" placeholder="State/Province *" required>
        </div>
        <div class="grid-3">
          <input name="postal" placeholder="Postal code *" required>
          <input name="country" placeholder="Country *" value="US" required>
          <span></span>
        </div>
        <button type="submit">Add attendee</button>
      </form>

      <div id="attendees"></div>
    </section>

    <section class="panel">
      <h2>Banquets</h2>
      <div id="banquets"></div>
    </section>
  </main>

  <footer class="site-footer">
    
    <div class="container">
      <nav class="site-nav nav footer-nav">
        <a href="home.html">Home</a>
        <span class="nav-current">Banquets</span>
        <a href="supreme-addons.html">Supreme Council Add-Ons</a>
        <!-- <a href="product-catalog.html" data-catalog-link>Product Catalog</a> -->
        
        <!-- TEMP: hide Supplies everywhere (weâ€™ll re-enable later) -->
        <a href="supplies.html">Supplies</a>

        <!-- <a href="charity.html" data-cat-link data-cat="charity">Charity</a> -->

        <a href="order.html">Cart</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>

    <div class="container tiny">Â© 2026</div>
  </footer>

  <!-- Optional legacy scripts -->
  <script src="assets/js/main.js" defer></script>

  <script>
  // Display as $X,XXX.00
  function money(n){
    const v = Math.max(0.01, Math.round(Number(n)*100)/100);
    return v.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2});
  }
  function normalizePrice(p){
    const n = Number(p);
    return (n > 0 && n < 1) ? Math.round(n*100) : n;
  }
  function looksLikeEmail(s){
    return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(s||'').trim());
  }

  function escHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (ch) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[ch]));
  }

  // Live phone formatter using Cart.phoneHelpers (shared across projects)
  function formatPhoneLive(inputEl){
    if (!inputEl) return;
    const helpers = (window.Cart && Cart.phoneHelpers) || null;
    if (!helpers) return;
    const raw = (inputEl.value || '').trim();
    if (raw.startsWith('+')) return; // keep international numbers intact
    const d = helpers.digitsOnly(raw).slice(0, 10); // cap to 10 digits
    inputEl.value = helpers.formatUS(d);
  }

  // ===== NEW helpers for duplicate detection (name + full address) =====
  function _norm(s){
    return String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
  }
  function _addressKey(a){
    // Build a consistent address signature
    return [
      _norm(a?.address1),
      _norm(a?.address2),
      _norm(a?.city),
      _norm(a?.state),
      _norm(a?.postal),
      _norm(a?.country || 'US')
    ].join('|');
  }
  function _sameNameAndAddress(a, b){
    return _norm(a?.name) === _norm(b?.name) &&
           _addressKey(a)  === _addressKey(b);
  }

  // ===== Shared attendee storage (same key as order.html) =====
  const ATTENDEE_STORAGE_KEY = "amaranth_attendees_v1";

  function saveAttendeesToStorage(list){
    try {
      const arr = Array.isArray(list) ? list : [];
      localStorage.setItem(ATTENDEE_STORAGE_KEY, JSON.stringify(arr));
    } catch(e){
      console.error("Failed to save attendees to shared storage", e);
    }
  }

  function syncAttendeesToStorageFromCart(){
    try {
      if (!window.Cart || typeof Cart.get !== "function") return;
      const st = Cart.get() || {};
      const attendees = Array.isArray(st.attendees) ? st.attendees : [];
      saveAttendeesToStorage(attendees);
    } catch(e){
      console.error("Failed to sync attendees from Cart to storage", e);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    Cart.load();

    // Initial sync: mirror current Cart attendees out to shared storage
    syncAttendeesToStorageFromCart();

    // Attendee UI render + add
    const list = document.getElementById('attendees');
    const form = document.getElementById('attForm');

    // Phone input: live US formatting (shared behavior desktop + mobile)
    const phoneInput = form ? form.querySelector('input[name="phone"]') : null;
    if (phoneInput){
      phoneInput.addEventListener('input', () => formatPhoneLive(phoneInput));
      phoneInput.addEventListener('blur',  () => formatPhoneLive(phoneInput));
    }

    // --- keep banquet attendee <select>s in sync without reload ---
    function getAttendees(){ return (Cart.get() || {}).attendees || []; }
    function repopulateSelect(sel){
      if (!sel) return;
      const a = getAttendees();
      const prev = sel.value;
      sel.innerHTML = '';
      if (!a.length){
        sel.disabled = true;
        sel.innerHTML = '<option value="">Add attendee first</option>';
      } else {
        sel.disabled = false;
        sel.innerHTML =
          '<option value="">Select attendeeâ€¦</option>' +
          a.map(at=>`<option value="${at.id}">${at.name || at.email}</option>`).join('');

        // Preserve previous selection if still valid; otherwise keep placeholder
        const hasPrev = a.some(x => String(x.id) === String(prev));
        sel.value = hasPrev ? prev : "";
      }
      sel.dispatchEvent(new Event('change'));
    }
    function repopulateAllAttendeeSelects(){
      document.querySelectorAll('.banquet-card .assign select').forEach(repopulateSelect);
    }
    // ---------------------------------------------------------------

    function renderAttendees(){
      const st = Cart.get();
      list.innerHTML = (st.attendees||[]).map(a=>{
        const hasAddr = !!(a?.address1 && a?.city && a?.state && a?.postal && a?.country);
        const addrLine = hasAddr ? 'Mailing address: attached' : 'Mailing address: missing';
        const phone = a?.phone ? ` â€¢ ${a.phone}` : '';
        
        const courtBits = [];
        if (a?.courtName) courtBits.push(escHtml(a.courtName));
        if (a?.courtNumber) courtBits.push('#' + escHtml(a.courtNumber));
        if (a?.jurisdiction) courtBits.push('(' + escHtml(a.jurisdiction) + ')');
        const courtLine = courtBits.length ? `<div class="tiny" style="opacity:.85;margin-top:2px;">Court: ${courtBits.join(' ')}</div>` : '';

        const memberLabel = (a?.memberType === 'voting') ? 'Voting' : ((a?.memberType === 'non_voting') ? 'Non-Voting' : '');
        const memberLine = memberLabel ? `<div class="tiny" style="opacity:.85;margin-top:2px;">Member: ${memberLabel}</div>` : '';
return `
          <div class="att-card">
            <div>
              <strong>${a.name||''}</strong>
              <small>${a.email||''}</small>
              <em>${a.title||''}</em>
              <div class="tiny" style="opacity:.9;margin-top:2px;">${addrLine}${phone}</div>
              ${courtLine}
              ${memberLine}
              ${a.notes ? `<div class="tiny" style="opacity:.8;margin-top:2px;">Notes: ${String(a.notes).replace(/</g,'&lt;')}</div>` : ''}
            </div>
            <button data-del="${a.id}">Remove</button>
          </div>
        `;
      }).join('');
      list.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = () => {
          Cart.removeAttendee(btn.dataset.del);
          renderAttendees();
          repopulateAllAttendeeSelects();
          // keep shared storage in sync after removal
          syncAttendeesToStorageFromCart();
        };
      });

      // After re-render, mirror attendees to shared storage
      syncAttendeesToStorageFromCart();
    }

    form.onsubmit = (e)=>{
      e.preventDefault();
      const fd = new FormData(form);

      const name   = (fd.get('name')||'').trim();
      const email  = (fd.get('email')||'').trim();
      const phone  = (fd.get('phone')||'').trim();
      const title  = (fd.get('title')||'').trim();
      const notes  = (fd.get('notes')||'').trim();
      
      const courtName   = (fd.get('courtName')||'').trim();
      const courtNumber = (fd.get('courtNumber')||'').trim();
      
      const jurisdiction = (fd.get('jurisdiction')||'').trim();
      
      if (!courtName || !courtNumber || !jurisdiction) {
        alert('Court Name, Court #, and Jurisdiction are required.');
        return;
      }
const memberType  = (fd.get('memberType')||'').trim(); // "voting" | "non_voting"
const address1 = (fd.get('addr1')||'').trim();
      const address2 = (fd.get('addr2')||'').trim();
      const city     = (fd.get('city')||'').trim();
      const state    = (fd.get('state')||'').trim();
      const postal   = (fd.get('postal')||'').trim();
      const country  = (fd.get('country')||'US').trim() || 'US';

      const missing = [];
      if (!name) missing.push('Name');
      if (!email || !looksLikeEmail(email)) missing.push('Valid Email');
      if (!phone) missing.push('Phone');
      if (!title) missing.push('Title');
            if (!memberType) missing.push('Membership (Voting / Non-Voting)');
if (!address1) missing.push('Address line 1');
      if (!city) missing.push('City');
      if (!state) missing.push('State/Province');
      if (!postal) missing.push('Postal code');
      if (!country) missing.push('Country');

      if (missing.length){
        alert('Please complete the following fields:\nâ€¢ ' + missing.join('\nâ€¢ '));
        return;
      }

      // ===== DUPLICATE CHECK: same Name + full Mailing Address =====
      const incoming = {
        name,
        address1, address2, city, state, postal, country
      };
      const st = Cart.get();
      const dup = (st.attendees||[]).some(a => _sameNameAndAddress(a, incoming));
      if (dup){
        alert('An attendee with the same name and mailing address already exists.');
        return;
      }
      // =============================================================

      Cart.addAttendee({
        name, email, phone, title, notes,
        memberType,
        courtNumber,
        courtName,
        jurisdiction,
        address1, address2, city, state, postal, country
      });
      form.reset();
      form.querySelector('input[name="country"]').value = 'US';

      renderAttendees();
      repopulateAllAttendeeSelects();
      // sync new list out to shared storage
      syncAttendeesToStorageFromCart();
    };
    renderAttendees();
    repopulateAllAttendeeSelects();

    // ===== Banquets UI =====
    const wrap = document.getElementById('banquets');

    function attendeeSelect(){
      const s = document.createElement('select');
      const a = (Cart.get() || {}).attendees || [];
      s.innerHTML = '';
      if (!a.length){
        s.disabled = true;
        s.innerHTML = '<option value="">Add attendee first</option>';
      } else {
        s.disabled = false;
        s.innerHTML = '<option value="">Select attendeeâ€¦</option>' +
          a.map(at=>`<option value="${at.id}">${at.name || at.email}</option>`).join('');
        // always start with placeholder selected
        s.value = "";
      }
      return s;
    }

    function addBanquet(b){
      if (b.active === false) return;

      const div = document.createElement('div');
      div.className = 'banquet-card';
      div.innerHTML = `
        <h3>${b.name}</h3>
        <div><small>${b.datetime || ''}</small></div>
        ${b.location ? `<div><small><em>${b.location}</em></small></div>` : ``}
        <p>${b.description || ''}</p>
        <!-- Ticket dropdown removed -->
        <div class="price-line"></div>
        <div class="meal"></div>
        <div class="assign"></div>
        <button class="add" disabled>Add to Order</button>
      `;

      // Compute default option (first available), fallback to b.price or 0
      let defaultChoice = null;
      if (Array.isArray(b.options) && b.options.length){
        defaultChoice = b.options.find(o => o && o.price != null && o.disabled !== true) || b.options[0];
      }
      if (!defaultChoice) {
        defaultChoice = { id: 'standard', label: 'Standard', price: (b.price != null ? b.price : 0) };
      }
      const unitPrice = normalizePrice(defaultChoice.price);

      // Show the price so users see cost even without a selector
      const priceLine = div.querySelector('.price-line');
      if (priceLine) {
        const label = defaultChoice.label ? ` â€” ${defaultChoice.label}` : '';
        priceLine.innerHTML = `<div style="margin:.25rem 0 .5rem;font-weight:600;">Price${label}: ${money(unitPrice)}</div>`;
      }

      // Meal choices (unchanged)
      if (Array.isArray(b.mealChoices) && b.mealChoices.length){
        const meal = div.querySelector('.meal');
        meal.innerHTML = `
          <div style="margin:.5rem 0 .25rem;font-weight:600;">Meal Preference *</div>
          ${b.mealChoices.map(m=>`
            <label style="margin-right:10px">
              <input type="radio" name="meal-${b.id}" value="${m}"> ${m}
            </label>
          `).join('')}
        `;
      }

      // Assign attendee
      const assign = div.querySelector('.assign');
      const attendeeSel = attendeeSelect();
      assign.appendChild(attendeeSel);

      const addBtn = div.querySelector('.add');
      const toggleAddBtn = () => { addBtn.disabled = !(attendeeSel && attendeeSel.value); };
      attendeeSel.addEventListener('change', toggleAddBtn);
      toggleAddBtn();

      addBtn.onclick = ()=>{
        if (!attendeeSel || !attendeeSel.value){ alert('Please select an attendee first.'); return; }

        let mealChoice = '';
        const mealRadios = div.querySelectorAll(`input[name="meal-${b.id}"]`);
        if (mealRadios && mealRadios.length){
          const checked = [...mealRadios].find(r => r.checked);
          if (!checked){ alert('Please choose a meal preference.'); return; }
          mealChoice = checked.value;
        }

        const st = Cart.get();
        const attendeeId = attendeeSel.value;
        const att = (st.attendees||[]).find(x=>x.id===attendeeId);
        const attendeeNotes = (att && att.notes) ? String(att.notes) : '';

        const dup = (st.lines || []).some(l =>
          l.attendeeId === attendeeId &&
          l.itemType === 'banquet' &&
          String(l.itemId).startsWith(b.id + ':')
        );
        if (dup){ alert('This attendee is already assigned to this banquet.'); return; }

        Cart.addLine({
          attendeeId,
          itemType: 'banquet',
          itemId: b.id + ":" + (defaultChoice.id || 'standard'),
          itemName: `${b.name}${mealChoice ? ` (${mealChoice})` : ''}`,
          qty: 1,
          unitPrice,
          meta: {
            mealChoice,
            attendeeNotes,
            event: b.datetime || "",
            location: b.location || "",
            // === pass attendee identity through to Stripe (so reports pick them up) ===
            attendeeName:  att?.name  || "",
            attendeeTitle: att?.title || "",
            attendeePhone: att?.phone || "",
            attendeeEmail: att?.email || "",
            // address (for directory CSV)
            attendeeAddr1:  att?.address1 || "",
            attendeeAddr2:  att?.address2 || "",
            attendeeCity:   att?.city     || "",
            attendeeState:  att?.state    || "",
            attendeePostal: att?.postal   || "",
            attendeeCountry:att?.country  || "US",
            // court / jurisdiction (for reports + chair emails)
            court: att?.courtName || "",
            court_number: att?.courtNumber || "",
            jurisdiction: att?.jurisdiction || "",
            memberType: att?.memberType || ""
          }
        });

        try { localStorage.setItem('amaranth_cart_ping', String(Date.now())); } catch(e) {}
        alert('Banquet added');
      };

      wrap.appendChild(div);
    }

    async function loadBanquets() {
      function isWithinWindow(b, nowTs){
        const s = b.publishStart ? Date.parse(b.publishStart) : null;
        const e = b.publishEnd   ? Date.parse(b.publishEnd)   : null;
        return (s == null || nowTs >= s) && (e == null || nowTs <= e);
      }

      const nowTs = Date.now();
      let list = [];

      try {
        const r = await fetch('/api/router?type=banquets', { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (Array.isArray(j?.banquets)) list = j.banquets;
        }
      } catch (e) {
        console.warn('Server banquets fetch failed:', e);
      }

      if (!list.length && Array.isArray(window.BANQUETS)) {
        list = window.BANQUETS;
      }

      // âœ… Apply SAME public sort as requested (active-now filter then sortOrder)
      list
        .filter(b => b.active !== false)
        .filter(b => isWithinWindow(b, nowTs))
        .sort((a,b) => (Number(a.sortOrder ?? 1000) - Number(b.sortOrder ?? 1000)))
        .forEach(addBanquet);
    }

    loadBanquets();

    // ===== KEEP IN SYNC WITH OTHER PAGES (Order, Add-ons, etc.) =====
    function resyncFromStorage(){
      try { Cart.load(); } catch(e){}
      try {
        renderAttendees();
        repopulateAllAttendeeSelects();
        // keep shared storage mirrored after reload
        syncAttendeesToStorageFromCart();
      } catch(e){}
    }

    // When cart changes anywhere in this tab
    window.addEventListener('cart:updated', () => {
      try {
        renderAttendees();
        repopulateAllAttendeeSelects();
        syncAttendeesToStorageFromCart();
      } catch(e){}
    });

    // When tab regains focus / becomes visible
    window.addEventListener('focus', resyncFromStorage);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) resyncFromStorage();
    });

    // Cross-tab/localStorage sync
    window.addEventListener('storage', (ev) => {
      try {
        if (!ev.key || ev.key === Cart.LS_KEY) {
          resyncFromStorage();
        }
      } catch(e){}
    });
  });
  </script>

  <style>
    .att-form input{margin:4px;padding:6px}
    .att-card{display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.78);border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:8px;margin:6px 0}
    .banquet-card{background:rgba(255,255,255,0.40);border:1px solid rgba(229,231,235,0.45);border-radius:10px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);backdrop-filter:saturate(120%) blur(2px);-webkit-backdrop-filter:saturate(120%) blur(2px)}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  </style>

  <!-- Core site scripts -->
  <script src="assets/js/site-settings.js"></script>
  <script src="assets/js/items.js"></script>
  <script src="assets/js/banquets.js"></script>
  <script src="assets/js/cart.js"></script>
  <script src="assets/js/data-store.js"></script>
  <script src="assets/js/site-boot.js"></script>

  <!-- Hide Product Catalog link if no visible items -->
  <script>
  (async function(){
    const link = document.querySelector('[data-catalog-link]');
    if (!link) return;

    async function fetchJson(url){
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) return null;
        return await r.json();
      } catch(e){ return null; }
    }

    let items = [];
    let j = await fetchJson('/api/router?type=products');
    if (Array.isArray(j?.products)) items = j.products;

    if (!items.length && Array.isArray(window.CATALOG_ITEMS)) items = window.CATALOG_ITEMS;

    const now = Date.now();
    const hasVisible = (items || []).some(i => {
      if (i && i.active === false) return false;
      const s = i?.publishStart ? Date.parse(i.publishStart) : null;
      const e = i?.publishEnd   ? Date.parse(i.publishEnd) : null;
      return (s == null || now >= s) && (e == null || now <= e);
    });

    if (!hasVisible) link.style.display = 'none';
  })();
  </script>

  <!-- Maintenance -->
  <script>
  (async () => {
    try {
      const resp = await fetch('/api/router?type=settings');
      const data = await resp.json();
      const on = data?.effective?.MAINTENANCE_ON ?? data?.MAINTENANCE_ON;
      const msg = data?.effective?.MAINTENANCE_MESSAGE ?? data?.MAINTENANCE_MESSAGE;
      if (on === 'true' || on === true) {
        document.body.innerHTML = `
          <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#fef2f2;color:#b91c1c;font-family:sans-serif;text-align:center;padding:20px">
            <h1 style="font-size:2em;margin-bottom:12px;">ðŸ›  Under Maintenance</h1>
            <p style="font-size:1.2em;max-width:500px;">
              ${msg || 'The site is temporarily unavailable. Please check back soon.'}
            </p>
          </div>
        `;
      }
    } catch (err) {
      console.error('Maintenance check failed:', err);
    }
  })();
  </script>


<script>
(async function(){
  async function hasActive(cat){
    try{
      const r = await fetch("/api/router?type=catalog_has_active&cat=" + encodeURIComponent(cat), { cache: "no-store" });
      if (!r.ok) return true;
      const j = await r.json();
      return !!(j && j.hasActive);
    }catch(e){
      // fail open: show links if API fails
      return true;
    }
  }
  const links = Array.from(document.querySelectorAll("[data-cat-link][data-cat]"));
  for (const a of links){
    const cat = a.getAttribute("data-cat") || "";
    const ok = await hasActive(cat);
    if (!ok) a.style.display = "none";
  }
})();
</script>
  <script src="/assets/js/visits.js?v=visits-v1"></script>

  <!-- Visitor tracking -->
  <script>
  (function () {
    try {
      const path = location.pathname;
      if (
        path.startsWith('/admin') ||
        path.includes('debug') ||
        path.startsWith('/api') ||
        path.startsWith('/assets')
      ) return;

      fetch(`/api/router?type=track_visit&path=${encodeURIComponent(path)}`, {
        method: 'GET',
        keepalive: true
      });
    } catch (e) {}
  })();
  </script>

</body>
</html>
